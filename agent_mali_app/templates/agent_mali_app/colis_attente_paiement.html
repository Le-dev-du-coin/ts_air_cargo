{% extends 'components/base_agent_mali.html' %}
{% load static %}

{% block title %}{{ title }} - TS Air Cargo{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 mb-1">Colis en Attente de Paiement</h2>
        <p class="text-muted mb-1">G√©rer les paiements des colis livr√©s</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'agent_mali:dashboard' %}" class="action-btn action-btn-outline">
            <i class="bi bi-arrow-left"></i>
            Retour Dashboard
        </a>
    </div>
</div>

<!-- Statistiques rapides -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="stat-card" style="border-left: 4px solid var(--danger-color);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h3 class="stat-value text-danger">{{ colis_attente.count }}</h3>
                    <p class="stat-label">Colis en Attente</p>
                    <div class="stat-change negative">
                        <i class="bi bi-clock-history"></i>
                        Paiements non r√©gl√©s
                    </div>
                </div>
                <i class="bi bi-exclamation-triangle stat-icon" style="color: var(--danger-color);"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="stat-card" style="border-left: 4px solid var(--warning-color);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    {% with total_value=colis_attente|length %}
                    {% with montant_total=0 %}
                    {% for colis in colis_attente %}
                        {% with montant_total=montant_total|add:colis.prix_calcule %}{% endwith %}
                    {% endfor %}
                    <h3 class="stat-value text-warning">
                        {% widthratio colis_attente.0.prix_calcule 1 colis_attente.count|default:0 %} F
                    </h3>
                    {% endwith %}
                    {% endwith %}
                    <p class="stat-label">Valeur Estim√©e</p>
                    <div class="stat-change neutral">
                        <i class="bi bi-cash-stack"></i>
                        √Ä recouvrer
                    </div>
                </div>
                <i class="bi bi-cash-stack stat-icon" style="color: var(--warning-color);"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="stat-card" style="border-left: 4px solid var(--info-color);">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h3 class="stat-value text-info">{{ colis_attente|length }}</h3>
                    <p class="stat-label">Actions Requises</p>
                    <div class="stat-change neutral">
                        <i class="bi bi-check2-square"></i>
                        Validation manuelle
                    </div>
                </div>
                <i class="bi bi-check2-square stat-icon" style="color: var(--info-color);"></i>
            </div>
        </div>
    </div>
</div>

<!-- Liste des colis -->
<div class="modern-card">
    <div class="modern-card-header">
        <h5 class="modern-card-title">
            <i class="bi bi-clock-history me-2"></i>
            Colis Livr√©s en Attente de Paiement
        </h5>
    </div>
    <div class="modern-card-body p-0">
        {% if colis_attente %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Colis</th>
                            <th>Client</th>
                            <th>Lot</th>
                            <th>Prix Transport</th>
                            <th>Date Livraison</th>
                            <th>Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for colis in colis_attente %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="package-icon me-3" style="width: 35px; height: 35px; background: var(--danger-color); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: white;">
                                        <i class="bi bi-box-seam"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ colis.numero_suivi }}</div>
                                        <div class="text-muted small">{{ colis.description|truncatechars:30 }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-semibold">{{ colis.client.user.get_full_name }}</div>
                                <div class="text-muted small">{{ colis.client.user.telephone }}</div>
                            </td>
                            <td>
                                <span class="badge bg-info text-dark">{{ colis.lot.numero_lot }}</span>
                            </td>
                            <td>
                                <div class="fw-semibold text-success">{{ colis.prix_calcule|floatformat:0 }} F</div>
                                <div class="text-muted small">{{ colis.get_type_transport_display }}</div>
                            </td>
                            <td>
                                {% with livraison=colis.livraisons.first %}
                                {% if livraison.date_livraison_effective %}
                                    <div class="fw-semibold">{{ livraison.date_livraison_effective|date:"d M Y" }}</div>
                                    <div class="text-muted small">{{ livraison.date_livraison_effective|date:"H:i" }}</div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-clock-history me-1"></i>
                                    En attente
                                </span>
                            </td>
                            <td class="text-end">
                                <form method="post" action="{% url 'agent_mali:marquer_paiement' colis.id %}" class="d-inline" id="payment-form-{{ colis.id }}">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-sm btn-success" 
                                            onclick="confirmPayment('{{ colis.id }}', '{{ colis.numero_suivi }}', '{{ colis.client.user.get_full_name }}', '{{ colis.prix_calcule|floatformat:0 }}')"
                                            title="Marquer comme pay√©">
                                        <i class="bi bi-check-circle"></i> Pay√©
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-check-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                <h4 class="mt-3 text-muted">Aucun colis en attente de paiement</h4>
                <p class="mb-0">Tous les colis livr√©s ont √©t√© pay√©s !</p>
                <a href="{% url 'agent_mali:dashboard' %}" class="btn btn-outline-primary mt-3">
                    <i class="bi bi-arrow-left"></i> Retour au Dashboard
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Note d'information -->
<div class="alert alert-info mt-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Information :</strong> 
    Seuls les colis avec le statut "Pay√©" sont d√©finitivement ferm√©s. 
    Les colis en attente de paiement peuvent encore √™tre modifi√©s jusqu'√† validation du paiement.
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmPayment(colisId, numeroSuivi, clientName, montant) {
    Swal.fire({
        title: 'üí∞ Confirmer le paiement',
        html: `
            <div class="text-start">
                <div class="mb-3 p-3 bg-light rounded">
                    <h6 class="mb-2"><i class="bi bi-box-seam text-primary me-2"></i>D√©tails du colis</h6>
                    <div class="row">
                        <div class="col-6"><strong>N¬∞ Suivi:</strong></div>
                        <div class="col-6">${numeroSuivi}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Client:</strong></div>
                        <div class="col-6">${clientName}</div>
                    </div>
                    <div class="row">
                        <div class="col-6"><strong>Montant:</strong></div>
                        <div class="col-6 text-success fw-bold">${montant} FCFA</div>
                    </div>
                </div>
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Attention:</strong> Cette action est irr√©versible. Le colis sera marqu√© comme pay√©.
                </div>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-check-circle me-2"></i>Confirmer le paiement',
        cancelButtonText: '<i class="bi bi-x-circle me-2"></i>Annuler',
        reverseButtons: true,
        customClass: {
            popup: 'text-start',
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-secondary'
        },
        buttonsStyling: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        showLoaderOnConfirm: true,
        preConfirm: () => {
            return new Promise((resolve) => {
                // Simuler une v√©rification
                setTimeout(() => {
                    resolve();
                }, 800);
            });
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Afficher un message de succ√®s temporaire
            Swal.fire({
                title: 'üéâ Paiement confirm√© !',
                text: `Le colis ${numeroSuivi} a √©t√© marqu√© comme pay√©.`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false,
                allowOutsideClick: false
            }).then(() => {
                // Soumettre le formulaire
                document.getElementById('payment-form-' + colisId).submit();
            });
        }
    });
}

// Animation au chargement des cartes
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.stat-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.5s ease';
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
});
</script>
{% endblock %}
